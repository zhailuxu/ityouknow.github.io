---
layout: post
title: 浅谈分布式领域CAP理论
category: java
excerpt: CAP理论你造？
tags: [java]
--- 




# 一、前言
CAP是分布式系统的重要理论，在大型分布式系统中一致性（Consistency），高可用性（High-Availability），分区可容忍性（Partition-tolerance）是设计者都希望能同时达到的，但是根据CAP理论一个系统最多能实现3中其2。本文不去探讨CAP理论的结论的正确性，而是去试图概述这三个特性是什么。
# 二、 一致性
一个完全一致性的系统可以保证一旦你修改了系统中存储的一个状态，那么在下次显示修改改状态值之前所有访问这个状态值的操作获取的状态值都是一样的。

[example1]例如一个单点MySQL数据库实例天然会保证状态的一致性，这是因为只有一个节点来保持这个状态。

[exmaple2]例如有两个MySQL数据库实例，并且数据是使用分片的方式将所有的数据分散到两个数据库实例上面，也就是两个数据库里面存放的为整体数据的一部分，那么这个情况下系统仍然天然具有完整一致性。

[exmaple3]假如现在数据库设置为主-主备份系统，其中一个数据库接受到插入数据请求时候，必须将该请求信息提交给另外一个数据库后，当前数据库的插入请求才被认为完成。那么为了保证100%的一致性，主-主备份数据库节点之间需要进行通信，并且随着备份节点的增多，系统整体性能会下降。

# 三、高可用性
在上面3个例子中[exmaple1]和[exmaple2]不是高可用性的，其中[exmaple1]如果数据库实例出现故障，那么100%的数据将会丢失，[exmaple2]中如果有一个节点发送故障，那么将会有50%的数据丢失。[exmaple3]是保证高可用的一个解决方法，一个简单的MySQL服务器备份（多主模式）可以提供100%的可用性，增加数据副本节点的数量将会直接增加系统的可用性，使用副本不仅保证了硬件故障时候的可用性，还有助于负载平衡和并发操作，特别是读取操作， “Slave”MySQL实例就是这种“复制”的完美例子。

# 四、分区可容忍性
假设[exmaple3]中两个MYSQL服务器处于两个不同的数据中心，并且两个服务器之间的网络失去了连接(比如其中一个节点挂了)，那么当前系统处于了分区状态，由于网络原因，数据库之间就无法进行数据同步，那么两个数据库就处于不一致性的状态了。当系统处于分区状态时候就需要衡量A和C直接那个更重要了，如果银行觉的一致性是非常重要的，并且在停机期间禁用写操作，则两个分行的所有银行账户现在将被冻结，直到网络恢复，然后这则将失去集群的“可用性”，如果银行觉得可用性比较重要，则没有挂的一个系统继续进行提供单点的服务，而这是牺牲了一致性。

# 五、总结
本文用了三个例子来阐述CAP，其中example1和example2上都能保证强一致性，但不能保证可用性。example3这个例子，由于存在分区，就需要在一致性与可用性之间进行选择。对应复制的策略很多场景下不需要保证强一致性，但是有时候需要保证C。比如银行交易需要保证C则要保证本地库和异地库同时进行更新才算成功。但是有些情况下需要保证高可用性，当一个数据库发生故障后自动切换到备库写，以便继续对外提供服务.

# 六、参考
本文翻译自文章 http://www.royans.net/wp/2010/02/14/brewers-cap-theorem-on-distributed-systems/ 并加入了作者的理解。

